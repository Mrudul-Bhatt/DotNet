Got it üëç I‚Äôll answer each in **Q & A format**, targeting **3‚Äì5 yrs Software Engineer interviews**, with **code + explanation**.

---

## **1. Q: Write a custom middleware that logs the incoming request path and the time it took to process the request. Show how to register this middleware in the Program.cs file.**

**A:**
A custom middleware can be written as a class or inline delegate. It logs request details **before** and **after** calling the next middleware.

**Code:**

```csharp
// Custom Middleware Class
public class RequestLoggingMiddleware
{
    private readonly RequestDelegate _next;

    public RequestLoggingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var path = context.Request.Path;
        var start = DateTime.UtcNow;

        Console.WriteLine($"Incoming Request: {path}");

        await _next(context); // call the next middleware

        var elapsed = DateTime.UtcNow - start;
        Console.WriteLine($"Request {path} completed in {elapsed.TotalMilliseconds} ms");
    }
}

// Extension method to register it
public static class RequestLoggingMiddlewareExtensions
{
    public static IApplicationBuilder UseRequestLogging(this IApplicationBuilder app)
    {
        return app.UseMiddleware<RequestLoggingMiddleware>();
    }
}
```

**Program.cs**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

// Register custom logging middleware
app.UseRequestLogging();

app.MapControllers();
app.Run();
```

‚úÖ **Why:** Helps track slow requests and debug request flow.

---

## **2. Q: You have a web API that needs to perform authentication and authorization. Write a code snippet showing the correct order of the Authentication and Authorization middleware in the pipeline, and explain why that order is critical.**

**A:**

* **Authentication** ‚Üí verifies *who* the user is.
* **Authorization** ‚Üí checks *what* the user is allowed to do.

**Correct Order:** Authentication must run **before** Authorization.

**Code:**

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services
builder.Services.AddAuthentication("Bearer")
    .AddJwtBearer("Bearer", options => { /* config */ });

builder.Services.AddAuthorization();

var app = builder.Build();

// Correct order
app.UseAuthentication();   // 1. Identify the user
app.UseAuthorization();    // 2. Enforce permissions

app.MapControllers();
app.Run();
```

‚úÖ **Why:** If Authorization runs first, it won‚Äôt know *who* the user is ‚Üí policies/roles won‚Äôt work correctly.

---

## **3. Q: Design a simple middleware that acts as a feature flag switch. It should check for a specific header in the request and, if present, route to a different set of middleware for a new feature. Use the app.Map() method in your solution.**

**A:**
We can use a middleware to check headers and redirect requests to a new feature branch.

**Code:**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

// Feature flag check middleware
app.Use(async (context, next) =>
{
    if (context.Request.Headers.ContainsKey("X-New-Feature"))
    {
        // Redirect to new feature branch
        context.Request.Path = "/new-feature";
    }
    await next();
});

// Old feature
app.Map("/old-feature", appBuilder =>
{
    appBuilder.Run(async context =>
    {
        await context.Response.WriteAsync("Old Feature Response");
    });
});

// New feature
app.Map("/new-feature", appBuilder =>
{
    appBuilder.Run(async context =>
    {
        await context.Response.WriteAsync("üöÄ New Feature Response");
    });
});

app.Run();
```

‚úÖ **Why:** Allows **safe rollout** of new features without changing existing controllers.

---

## **4. Q: You are trying to debug a request in a large ASP.NET Core application. Explain how you would use custom logging middleware to diagnose a problem without changing every single controller method.**

**A:**
Instead of adding `Console.WriteLine` or logs in every controller, we can use a **global custom middleware** that logs request/response details.

**Example Middleware:**

```csharp
public class DebugLoggingMiddleware
{
    private readonly RequestDelegate _next;

    public DebugLoggingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        Console.WriteLine($"[DEBUG] Path: {context.Request.Path}, Method: {context.Request.Method}");

        await _next(context);

        Console.WriteLine($"[DEBUG] Response Status: {context.Response.StatusCode}");
    }
}
```

**Register in Program.cs**

```csharp
app.UseMiddleware<DebugLoggingMiddleware>();
```

‚úÖ **Why:**

* Captures request/response globally.
* No need to modify individual controllers.
* Helps debug issues like wrong routes, headers, or response codes.

---

Would you like me to also prepare a **‚Äúmiddleware order diagram‚Äù (request in ‚Üí middleware chain ‚Üí response out)** so you can quickly recall during interviews?
